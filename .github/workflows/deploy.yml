name: Deploy Angular to GitHub Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

env:
  NODE_VERSION: '20'
  COVERAGE_THRESHOLD: 80
  PROJECT_NAME: 'es-lint3'

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    outputs:
      coverage-status: ${{ steps.coverage-check.outputs.status }}
      lint-status: ${{ steps.lint-check.outputs.status }}
      build-status: ${{ steps.build-check.outputs.status }}
      deploy-status: ${{ steps.deployment.outputs.status }}
    steps:
      - name: ğŸ—ï¸ Checkout repository
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ”„ Cache node_modules
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-
            
      - name: ğŸ“¥ Install dependencies
        run: npm ci
        
      - name: ğŸ§ª Run Jest tests with coverage
        id: test
        run: |
          echo "Running Jest tests with coverage validation..."
          npm run test:ci || (echo "::error::Test suite failed" && exit 1)
          
      - name: ğŸ“Š Validate test coverage
        id: coverage-check
        run: |
          echo "Checking test coverage threshold..."
          
          # Check if coverage files exist
          if [ ! -f "coverage/lcov.info" ]; then
            echo "::error::Coverage file not found"
            echo "status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          # Parse coverage from lcov.info file using awk for better reliability
          TOTAL_LINES=$(grep -E "^LH:" coverage/lcov.info | awk -F: '{sum += $2} END {print sum}')
          COVERED_LINES=$(grep -E "^LF:" coverage/lcov.info | awk -F: '{sum += $2} END {print sum}')
          
          if [ -z "$TOTAL_LINES" ] || [ -z "$COVERED_LINES" ] || [ "$COVERED_LINES" -eq 0 ]; then
            echo "::error::Unable to extract coverage data from lcov.info"
            echo "status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          # Calculate coverage percentage using awk for floating point arithmetic
          COVERAGE=$(awk "BEGIN {printf \"%.2f\", ($TOTAL_LINES / $COVERED_LINES) * 100}")
          
          echo "Current coverage: ${COVERAGE}%"
          echo "Required coverage: ${COVERAGE_THRESHOLD}%"
          
          # Compare coverage using awk for floating point comparison
          MEETS_THRESHOLD=$(awk "BEGIN {print ($COVERAGE >= $COVERAGE_THRESHOLD)}")
          
          if [ "$MEETS_THRESHOLD" = "1" ]; then
            echo "âœ… Coverage check passed: ${COVERAGE}% >= ${COVERAGE_THRESHOLD}%"
            echo "status=passed" >> $GITHUB_OUTPUT
          else
            echo "::error::âŒ Deployment stopped: Code coverage below ${COVERAGE_THRESHOLD}% (Actual: ${COVERAGE}%)"
            echo "status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi
          
      - name: ğŸ” Run ESLint validation
        id: lint-check
        run: |
          echo "Running ESLint validation..."
          
          # Run ESLint check (without auto-fix)
          if npm run lint:check; then
            echo "âœ… ESLint validation passed"
            echo "status=passed" >> $GITHUB_OUTPUT
          else
            echo "::error::âŒ Deployment stopped: ESLint validation failed"
            echo "status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi
          
      - name: ğŸ—ï¸ Build Angular application
        id: build-check
        run: |
          echo "Building Angular application..."
          
          # Build with base-href for GitHub Pages
          if npm run build -- --base-href '/EsLint3/'; then
            echo "âœ… Angular build completed successfully"
            echo "status=passed" >> $GITHUB_OUTPUT
          else
            echo "::error::âŒ Angular build failed"
            echo "status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi
          
      - name: ğŸ”§ Fix SPA routing for GitHub Pages
        run: |
          echo "Copying index.html to 404.html for SPA routing..."
          cp dist/${{ env.PROJECT_NAME }}/index.html dist/${{ env.PROJECT_NAME }}/404.html
          echo "âœ… SPA routing fix applied"
          
      - name: âš™ï¸ Configure GitHub Pages
        uses: actions/configure-pages@v4
        
      - name: ğŸ“¦ Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'dist/${{ env.PROJECT_NAME }}'
          
      - name: ğŸš€ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  notify:
    runs-on: ubuntu-latest
    needs: build-and-test
    if: always()
    steps:
      - name: ğŸ“¢ Deployment Notification
        run: |
          echo "=== DEPLOYMENT SUMMARY ==="
          
          COVERAGE_STATUS="${{ needs.build-and-test.outputs.coverage-status }}"
          LINT_STATUS="${{ needs.build-and-test.outputs.lint-status }}"
          BUILD_STATUS="${{ needs.build-and-test.outputs.build-status }}"
          DEPLOY_STATUS="${{ needs.build-and-test.result }}"
          
          if [ "$DEPLOY_STATUS" == "success" ]; then
            echo "ğŸ‰ âœ… Deployment succeeded!"
            echo "ğŸŒ Your site is available at: https://AishwaryaKulkarni1801.github.io/EsLint3/"
            echo ""
            echo "âœ… Jest tests: PASSED"
            echo "âœ… Coverage validation: PASSED (â‰¥80%)"
            echo "âœ… ESLint validation: PASSED"
            echo "âœ… Angular build: PASSED"
            echo "âœ… GitHub Pages deployment: PASSED"
          else
            echo "âŒ Deployment failed"
            echo ""
            
            # Determine failure reason
            if [ "$COVERAGE_STATUS" == "failed" ]; then
              echo "ğŸ’¥ Failure reason: Jest test coverage below 80%"
            elif [ "$LINT_STATUS" == "failed" ]; then
              echo "ğŸ’¥ Failure reason: ESLint validation failed"
            elif [ "$BUILD_STATUS" == "failed" ]; then
              echo "ğŸ’¥ Failure reason: Angular build failed"
            else
              echo "ğŸ’¥ Failure reason: Test suite failed or other build error"
            fi
            
            echo ""
            echo "ğŸ”§ Please check the workflow logs above for detailed error information."
            echo "ğŸ”§ Fix the issues and push again to retry deployment."
          fi
          
          echo "=========================="
